# Expense Tracker 

App for logging personal expenses 

## Setup 

Before you start, make sure you have all requirements:
- Python 3.12 or newer
- Docker

After cloning the repo: 
- Setup Python virtual environment
  - Sync: `uv sync`
  - Add local dir as `PYTHONPATH`: `echo "export PYTHONPATH=$(pwd)" >> .venv/bin/activate`
  - Activate: `source .venv/bin/activate`
- Start PostgreSQL `docker-compose up -d`
  - Verify `expense_tracker_db` container is started with `docker ps`
  - List dbs, verify `expense_tracker` db exists: `docker exec -it expense_tracker_db psql -U postgres -c "\l"`
  - Verify db is empty: `docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"` returns `Did not find any relations.`
- Start the FastAPI application with uvicorn `uvicorn expense_tracker.main:app --reload --workers 1`
  - Verify docs at http://localhost:8000/docs
- Initialize the DB with alembic migration
  - Initialize alembic `alembic init alembic`
  - `alembic.ini` is already available in the repo 
  - Copy predefined alembic env.py `cp alembic_env.py alembic/env.py`
  - Create initial migration `alembic revision --autogenerate -m "Create users and categories tables"`
  - Run the migration `alembic upgrade head`
  - Verify tables are created 
```
  docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"
              List of relations
 Schema |      Name       | Type  |  Owner
--------+-----------------+-------+----------
 public | alembic_version | table | postgres
 public | category        | table | postgres
 public | expense         | table | postgres
 public | shared_expense  | table | postgres
 public | user            | table | postgres
(5 rows)
```
  - Seed the DB `python scripts/seed_db.py`
  - Verfy user table: `docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "SELECT * FROM \"user\";"`
  - Test the endpoint: 
```
curl -X POST "http://localhost:8000/api/v1/users" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "username": "testuser"
  }'
```

### DB migration

#### Init
Initialize alembic `alembic init alembic` then update alembic.ini and alembic/env.py

Create initial migration
`alembic revision --autogenerate -m "Create users and categories tables"`

Run the migration
`alembic upgrade head`

#### New migration
Add new migration, after script is autogenerated, populated it with custom migration steps
```
alembic revision -m "Add missing constraints"
```

```
➜ alembic revision --autogenerate -m "Initial migration"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
  Generating /Users/markostanojlovic/code/expense-tracker/alembic/versions/a2e70ed5ecaa_initial_migration.py ...  done

➜ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> a2e70ed5ecaa, Initial migration
```

```
docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"

              List of relations
 Schema |      Name       | Type  |  Owner
--------+-----------------+-------+----------
 public | alembic_version | table | postgres
 public | categories      | table | postgres
 public | users           | table | postgres
```

## Start db in docker and start app in Python venv

TODO: one command to rule them all

```
docker-compose up -d
uvicorn expense_tracker.main:app --reload --workers 1
```

Example: 
```
➜ docker-compose up -d
[+] Running 2/2
 ✔ Network expense-tracker_expense_tracker_network  Created   0.0s
 ✔ Container expense_tracker_db  Started                      0.2s

➜ docker-compose up -d
[+] Running 1/0
 ✔ Container expense_tracker_db  Running                       0.0s

➜ uvicorn expense_tracker.main:app --reload --workers 1
INFO:     Will watch for changes in these directories: ['/Users/markostanojlovic/code/expense-tracker']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [65712] using StatReload
INFO:     Started server process [65714]
INFO:     Waiting for application startup.
INFO:     Application startup complete.

```

## Test all endpoints 
### Requirements
#### Clone prod db for testing purposes 
`CREATE DATABASE expense_tracker_test TEMPLATE expense_tracker;`
### Run endpoint tests 
While db and app are running:
`pytest test/ -v`

```
➜ pytest test/ -v

================================================================ test session starts =================================================================
platform darwin -- Python 3.12.7, pytest-8.3.3, pluggy-1.5.0 -- /Users/markostanojlovic/code/expense-tracker/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/markostanojlovic/code/expense-tracker
configfile: pyproject.toml
plugins: asyncio-0.24.0, cov-6.0.0, env-1.1.5, anyio-4.6.2.post1
asyncio: mode=Mode.STRICT, default_loop_scope=function
collected 5 items

test/test_users.py::TestUserEndpoints::test_create_user PASSED                                                                                 [ 20%]
test/test_users.py::TestUserEndpoints::test_get_user PASSED                                                                                    [ 40%]
test/test_users.py::TestUserEndpoints::test_update_user PASSED                                                                                 [ 60%]
test/test_users.py::TestUserEndpoints::test_delete_user PASSED                                                                                 [ 80%]
test/test_users.py::TestUserEndpoints::test_list_users PASSED                                                                                  [100%]

================================================================= 5 passed in 0.21s ==================================================================

```
