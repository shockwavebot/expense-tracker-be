# Expense Tracker 

App for logging personal expenses 

## Setup 

Before you start, make sure you have all requirements:
- Python 3.12 or newer
- Docker

After cloning the repo: 
- Setup Python virtual environment
  - Sync: `uv sync`
  - Add local dir as `PYTHONPATH`: `echo "export PYTHONPATH=$(pwd)" >> .venv/bin/activate`
  - Activate: `source .venv/bin/activate`
- Start PostgreSQL `docker-compose up -d`
  - Verify `expense_tracker_db` container is started with `docker ps`
  - List dbs, verify `expense_tracker` db exists: `docker exec -it expense_tracker_db psql -U postgres -c "\l"`
  - Verify db is empty: `docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"` returns `Did not find any relations.`
- Start the FastAPI application with uvicorn `uvicorn expense_tracker.main:app --reload --workers 1`
  - Verify docs at http://localhost:8000/docs
- Initialize the DB with alembic migration
  - Initialize alembic `alembic init alembic`
  - `alembic.ini` is already available in the repo 
  - Copy predefined alembic env.py `cp alembic_env.py alembic/env.py`
  - Create initial migration `alembic revision --autogenerate -m "Create users and categories tables"`
  - Run the migration `alembic upgrade head`
  - Verify tables are created 
```
  docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"
              List of relations
 Schema |      Name       | Type  |  Owner
--------+-----------------+-------+----------
 public | alembic_version | table | postgres
 public | category        | table | postgres
 public | expense         | table | postgres
 public | shared_expense  | table | postgres
 public | user            | table | postgres
(5 rows)
```
  - Seed the DB `python scripts/seed_db.py`
  - Verfy user table: `docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "SELECT * FROM \"user\";"`
  - Test the endpoint: 
```
curl -X POST "http://localhost:8000/api/v1/users" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "username": "testuser"
  }'
```

### DB migration

#### Init
Initialize alembic `alembic init alembic` then update alembic.ini and alembic/env.py

Create initial migration
`alembic revision --autogenerate -m "Create users and categories tables"`

Run the migration
`alembic upgrade head`

#### New migration
Add new migration, after script is autogenerated, populated it with custom migration steps
```
alembic revision -m "Add missing constraints"
```

```
➜ alembic revision --autogenerate -m "Initial migration"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
  Generating /Users/markostanojlovic/code/expense-tracker/alembic/versions/a2e70ed5ecaa_initial_migration.py ...  done

➜ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> a2e70ed5ecaa, Initial migration
```

```
docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"

              List of relations
 Schema |      Name       | Type  |  Owner
--------+-----------------+-------+----------
 public | alembic_version | table | postgres
 public | categories      | table | postgres
 public | users           | table | postgres
```

## Helper commands 
Docker&psql:

```
# list tables
docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "\dt"
# list users
docker exec -it expense_tracker_db psql -U postgres -d expense_tracker -c "SELECT * FROM \"user\";"
docker-compose exec postgres psql -U expense_tracker -d expense_tracker -c "DROP TABLE IF EXISTS alembic_version;"
```

Drop table:
```
DROP DATABASE expense_tracker;
CREATE DATABASE expense_tracker;
```

